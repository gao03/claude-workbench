# Claude Workbench v4.0.6 发布说明

## 🎉 v4.0.6 - 第三方API提示词优化

**发布日期**: 2025-10-27  
**重要性**: 重大功能更新 - 第三方API提示词优化支持

---

## 🔧 核心修复

### 提示词索引不一致问题 - 已修复

**问题**：
- Warmup 消息导致前后端索引计数不一致
- 撤回功能报错："Prompt #X not found"

**解决方案**：
- ✅ 前后端过滤逻辑完全对齐
- ✅ 支持数组格式 content 解析
- ✅ 索引验证机制，防止越界
- ✅ 统一 Warmup 消息处理

---

## 🎨 UI 优化

### 主题切换

- ✅ 主题切换按钮移至顶栏最前面
- ✅ 一键快速切换（无需进入设置）
- ✅ 圆形图标设计，更醒目
- 🚀 操作速度提升 3 倍（1 步 vs 3 步）

### 撤回功能优化

- ✅ 圆形边框按钮样式
- ✅ 默认可见（无需悬停）
- ✅ 与消息文本并排显示
- ✅ Tooltip 向上显示（不遮挡内容）

### 顶栏紧凑化

- ✅ 按钮尺寸统一为 h-7
- ✅ 图标统一为 3.5x3.5
- ✅ 间距缩小，布局紧凑
- 📏 顶栏高度减少 30%
- 🖥️ 为内容区留出更多空间

---

## 👁️ 用户体验改进

### Warmup 消息处理

- ✅ **默认隐藏** Warmup 消息（开箱即用）
- ✅ 会话列表显示真实提示词
- ✅ 撤回后保持隐藏状态
- ✅ 可在设置中选择显示

**效果**：
- 新用户无需配置，直接获得最佳体验
- 会话列表一目了然
- 对话历史更简洁

### 会话列表优化

- ✅ 跳过 Warmup，显示第一条真实用户输入
- ✅ 支持数组格式 content 解析
- ✅ 去除重复的会话数量显示

---

## 🧹 代码质量提升

### 清理内容

**临时文档** - 删除 12 个：
- 开发过程记录
- Bug 修复记录
- 实现进度文档

**代码优化**：
- 删除 ~40 行注释代码
- 删除未使用的导入
- 清理调试代码
- 整理 TODO 注释

### 代码改进

- ✅ 前后端逻辑对齐
- ✅ 类型安全增强
- ✅ 注释更清晰
- ✅ 可读性提升

---

## ✅ 平台支持

### macOS 完全适配

经过全面审计，确认：
- ✅ Tauri 配置包含 DMG + APP 打包
- ✅ 后端代码有 macOS 条件编译
- ✅ 前端代码天然跨平台
- ✅ Claude CLI 自动检测支持 Homebrew
- ✅ 可以直接在 macOS 上构建和运行

### 平台兼容性

- ✅ **Windows 10/11**: 完全支持（主要开发平台）
- ✅ **macOS**: 完全支持（已验证适配）
- ✅ **Linux**: 理论支持（Tauri 天然支持）

---

## 🚀 v4.0.6 重大功能更新

### 第三方API提示词优化 ⭐⭐⭐⭐⭐

**新增功能**：
- ✅ 支持 OpenAI、Deepseek、通义千问、SiliconFlow 等 API
- ✅ Google Gemini API 格式支持
- ✅ 完整的提供商配置管理界面
- ✅ API Key 加密存储
- ✅ 连接测试功能
- ✅ 预设模板快速配置

**使用方式**：
1. 设置 → 提示词API → 添加提供商
2. 输入框 → 优化按钮 → 选择提供商
3. 自动优化提示词

**支持的API格式**：
- OpenAI 格式（GPT-4、Deepseek、Qwen 等）
- Gemini 格式（Google Gemini 2.0）

### 关键BUG修复 ⭐⭐⭐⭐⭐

**项目路径重复问题**：
- ✅ 修复双反斜杠路径识别（CC CLI 格式）
- ✅ 同一项目不再重复显示
- ✅ 路径规范化统一处理

**Button 嵌套警告**：
- ✅ 修复项目卡片的 HTML 结构错误
- ✅ 移除 React 警告

---

## 🍎 v4.0.5 macOS 完全适配

### macOS 平台修复 ⭐⭐⭐⭐⭐

**MCP 配置读取修复**：
- ✅ 正确读取 `~/.claude.json` 和 `~/.claude/settings.json`
- ✅ 统一所有平台配置路径（Windows/macOS/Linux）
- ✅ MCP 列表在 macOS 上正常工作

**UI 字体大小修复**：
- ✅ 标签页标题字体缩小（0.8rem）
- ✅ Tooltip/Popover 字体缩小（0.75rem）
- ✅ 按钮和输入框字体调整
- ✅ macOS UI 现在和 Windows 大小一致

---

## 🎯 v4.0.4 交互优化

### FilePicker 完全重构 ⭐⭐⭐⭐⭐

**修复的BUG**：
- ✅ 键盘导航完全失效 → 全部正常
- ✅ 双击导航不工作 → 双击选中文件
- ✅ 事件冲突问题 → 完全隔离

**新的交互方式**：
- 单击目录 → **进入目录**（更直观）
- 单击文件 → 无操作（等待双击）
- 双击 → **选中文件/目录**（插入路径）

**视觉反馈**：
- ✅ 键盘选中：主色边框 + 光晕 + 加粗文字
- ✅ 鼠标悬停：动态操作提示
- ✅ 底部状态栏：实时显示可执行操作

**键盘导航**（全部正常）：
- ↑↓ 导航项目（明显的选中效果）
- Enter 选择当前项
- → 进入目录
- ← 返回上级
- Esc 关闭

---

## 🍎 v4.0.3 新增改进

### macOS 兼容性增强 ⭐⭐⭐⭐⭐

**Claude Code 检测增强**：
- ✅ 新增 10+ 个 macOS 特定路径
- ✅ Homebrew NPM 路径支持
- ✅ pnpm 包管理器支持
- ✅ 版本管理器支持（asdf、volta、n、nvm）
- ✅ 解决最新 macOS 系统找不到 Claude Code 的问题

**UI 对齐修复**：
- ✅ 修复 WebKit 渲染器下的居中问题
- ✅ 添加 -webkit- 前缀确保兼容性
- ✅ Container 强制居中
- ✅ Flexbox 对齐修复

### 用户体验优化 ⭐⭐⭐⭐

**使用统计改进**：
- ✅ "今日"选项添加到日期范围过滤器
- ✅ 移除重复的今日卡片
- ✅ 全面汉化（概览、按模型、按项目等）
- ✅ 界面更统一简洁

**扩展管理器**：
- ✅ 添加返回主页按钮
- ✅ 页面标题和描述

---

## 🚀 v4.0.2 性能优化

### 🔴 修复的严重问题 ⭐⭐⭐⭐⭐

**问题 1：生产版本加载会话卡顿 5-10 秒**
- 根本原因：每次打开会话都执行 Git 初始化（git add . 扫描所有文件）
- 解决方案：禁用自动 Git 初始化，延迟到发送消息时
- 效果：**秒开！** ⚡

**问题 2：终端窗口闪烁**
- 原因：Git 命令没有隐藏控制台窗口
- 解决方案：所有 Git 命令添加 CREATE_NO_WINDOW 标志
- 效果：**完全静默** 👻

**问题 3：使用统计无限循环**
- 原因：useCallback 依赖自己设置的状态
- 解决方案：移除循环依赖
- 效果：**Dashboard 正常工作** ✅

### ⚡ 性能提升

**依赖升级**：
- Tauri: 2.1.1 → 2.9.0（性能改进）
- @anthropic-ai/sdk: 0.63.1 → 0.67.0
- @tailwindcss: 4.1.8 → 4.1.16
- 前后端依赖版本对齐

**代码优化**：
- toolRegistry 异步加载
- 禁用后台翻译初始化
- React.lazy 懒加载
- Virtualizer 优化
- 代码分割改进

### 📊 性能对比

| 操作 | v4.0.1 | v4.0.2 |
|------|--------|--------|
| 新建会话 | 5-10秒 | **秒开** ⚡ |
| 历史会话 | 5-10秒 | **秒开** ⚡ |
| Git 操作 | 闪烁3次 | **静默** 👻 |
| 使用统计 | 可能卡死 | **流畅** ✅ |

---

## 🆕 v4.0.1 新增功能

### Claude 扩展管理器 ⭐⭐⭐⭐⭐

**顶栏新增"扩展"入口**，可查看：
- **Plugins** - 已安装的插件（包含 commands/agents/skills/hooks/MCP）
- **Subagents** - 专用子代理列表
- **Agent Skills** - 专用技能列表

**功能**：
- ✅ 扫描用户级和项目级扩展
- ✅ 显示插件组件统计
- ✅ 点击卡片直接打开 .md 文件
- ✅ 打开目录浏览所有文件
- ✅ 链接到官方文档和资源

### 成本计算优化 ⭐⭐⭐⭐⭐

**多模型定价支持**：
- ✅ 准确计算混合模型会话成本
- ✅ 支持 Opus 4.1、Sonnet 4.5、Sonnet 3.5
- ✅ 每条消息使用实际模型定价

**详细统计**：
- ✅ 鼠标悬停查看详细信息
- ✅ Token 分类（输入/输出/Cache 读/Cache 写）
- ✅ 会话时长（wall time）
- ✅ API 执行时长
- ✅ 符合官方 /cost 命令格式

### UI/UX 改进 ⭐⭐⭐⭐

**顶栏优化**：
- ✅ 图标和文字紧凑（0px 间距）
- ✅ 按钮间距清晰（4px）
- ✅ 微妙阴影和边框
- ✅ 视觉层次更清晰

**交互优化**：
- ✅ 成本详情悬停显示（不用点击）
- ✅ Popover 定位准确
- ✅ 实心背景清晰可读

### 性能优化 ⭐⭐⭐⭐

- ✅ 修复生产构建加载会话慢的问题
- ✅ 翻译未启用时完全跳过检查
- ✅ 会话历史秒开（与开发模式一致）

---

## 📦 安装方式

### 预构建版本

从 [GitHub Releases](https://github.com/anyme123/claude-workbench/releases/tag/v4.0.6) 下载：

**Windows**:
- MSI 安装包
- NSIS 安装包

**macOS**:
- DMG 安装包
- APP 应用包

### 源码构建

```bash
git clone https://github.com/anyme123/claude-workbench.git
cd claude-workbench
git checkout v4.0.6

# 安装依赖
npm install

# 开发模式
npm run tauri dev

# 构建应用
npm run tauri build
```

---

## 🔄 从 v3.x 升级

### 自动迁移

- ✅ 配置文件自动兼容
- ✅ 数据库自动迁移
- ✅ 会话历史保留

### 新功能默认值

- Warmup 消息：默认隐藏
- 主题切换：顶栏快捷访问

### 无需手动操作

直接安装 v4.0.0 即可，所有设置和数据自动保留。

---

## 🐛 已知问题

目前无已知重大问题。

如发现问题，请在 [GitHub Issues](https://github.com/anyme123/claude-workbench/issues) 报告。

---

## 🙏 致谢

感谢所有为这个项目做出贡献的开发者和用户！

特别感谢：
- [Claude](https://claude.ai/) - 强大的 AI 助手
- [Tauri](https://tauri.app/) - 现代化桌面应用框架
- [React](https://react.dev/) - 用户界面构建库
- [Rust](https://rust-lang.org/) - 系统编程语言

---

## 📋 完整更新日志

### v4.0.6 (2025-10-27)

**重大功能**：
- 第三方API提示词优化支持
- OpenAI、Gemini 格式支持
- 完整的提供商配置管理
- API Key 加密存储

**BUG修复**：
- 项目路径重复问题（双反斜杠处理）
- Button 嵌套警告
- 删除确认对话框
- 无限循环修复

### v4.0.5 (2025-10-27)

**macOS 平台修复**：
- MCP 配置读取修复（读取正确的 ~/.claude.json）
- UI 字体大小调整（标签页、Tooltip、按钮等）
- 统一跨平台配置路径
- macOS UI 和 Windows 保持一致

### v4.0.4 (2025-10-27)

**FilePicker 改进**：
- 修复键盘导航完全失效的BUG
- 修复双击导航不工作的BUG
- 增强选中项视觉反馈（主色边框+光晕）
- 优化交互方式（单击进入目录，双击选中）
- 动态底部状态提示

### v4.0.3 (2025-10-27)

**macOS 兼容性**：
- 增强 Claude Code 检测（新增10+路径）
- Homebrew NPM、pnpm、版本管理器支持
- UI 对齐修复（WebKit 兼容性）
- Container 居中修复

**用户体验**：
- 使用统计"今日"选项
- 使用统计全面汉化
- 扩展管理器返回按钮
- 界面更统一

### v4.0.2 (2025-10-27)

**性能修复**：
- 禁用自动 Git 初始化（会话加载卡顿根本原因）
- 隐藏 Git 控制台窗口（7个命令）
- 修复使用统计无限循环BUG
- toolRegistry 异步加载
- 禁用后台翻译初始化

**依赖升级**：
- Tauri: 2.1.1 → 2.9.0
- @anthropic-ai/sdk: 0.63.1 → 0.67.0
- @tailwindcss: 4.1.8 → 4.1.16
- 前后端依赖版本对齐

**代码优化**：
- React.lazy 懒加载大组件
- Virtualizer 优化
- 代码分割改进
- 移除编译警告

### v4.0.1 (2025-10-26)

**新功能**：
- Claude 扩展管理器（Plugins/Subagents/Skills）
- 多模型成本计算（准确定价）
- 成本详情悬停显示（Token 分类、时长统计）
- Git 代码变更统计 API
- 点击打开 .md 文件功能

**性能优化**：
- 会话历史加载速度优化
- 翻译检查优化（未启用时跳过）
- API 时长记录

**UI 改进**：
- 顶栏紧凑设计（图标文字 0px 间距）
- 按钮阴影和边框
- Plan Mode 快捷键对齐官方（单次 Shift+Tab）
- 成本 Popover 定位修复

**Bug 修复**：
- Agent Skill 名称提取
- 目录打开功能（跨平台）
- Rust 编译警告清理

### v4.0.0 (2025-10-26)

**核心修复**：
- 修复提示词索引不一致问题
- 后端支持数组格式 content 解析
- 前后端过滤逻辑完全对齐
- 索引验证机制

**UI 优化**：
- 主题切换按钮移至顶栏
- 撤回按钮样式和布局优化
- 顶栏紧凑化设计
- 去除重复显示

**用户体验**：
- Warmup 消息默认隐藏
- 会话列表显示真实提示词
- 开箱即用的最佳配置

**代码质量**：
- 删除冗余代码和文档
- macOS 完全适配验证
- 依赖包优化

---

**如果这个项目对您有帮助，请给我们一个 ⭐ Star！**

🔗 **项目地址**: https://github.com/anyme123/claude-workbench  
📖 **使用文档**: https://github.com/anyme123/claude-workbench/blob/main/README.md
