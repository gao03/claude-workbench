# 提示词上下文配置功能使用说明

## 📖 功能概述

提示词上下文配置功能允许你自定义在使用第三方 API 优化提示词时，提取多少会话历史作为上下文。这可以帮助 AI 更好地理解当前对话场景，生成更相关的优化建议。

## ✨ 功能特性

### 1️⃣ **可配置的上下文提取参数**

- **最大消息数量** (3-50 条)
  - 从会话历史中提取的最近消息数量
  - 默认：15 条

- **助手消息最大长度** (200-10,000 字符)
  - 单条助手回复的最大字符数，超过会被截断
  - 默认：2,000 字符

- **用户消息最大长度** (200-5,000 字符)
  - 单条用户提问的最大字符数，超过会被截断
  - 默认：1,000 字符

- **包含执行结果** (开关)
  - 是否在上下文中包含命令执行结果
  - 默认：开启

- **执行结果最大长度** (100-2,000 字符)
  - 单条执行结果的最大字符数，超过会被截断
  - 默认：500 字符

### 2️⃣ **预设模板**

提供三种预设配置，快速切换：

#### 🟢 **精简模式**
适合简单任务，减少 token 消耗
- 消息数量：5 条
- 助手消息长度：500 字符
- 用户消息长度：500 字符
- 不包含执行结果

#### 🟡 **平衡模式** (默认)
适合大多数场景，平衡质量与成本
- 消息数量：15 条
- 助手消息长度：2,000 字符
- 用户消息长度：1,000 字符
- 包含执行结果（500 字符）

#### 🔴 **详细模式**
适合复杂任务，提供完整上下文
- 消息数量：30 条
- 助手消息长度：5,000 字符
- 用户消息长度：2,000 字符
- 包含执行结果（1,000 字符）

## 🚀 使用方法

### 1. 打开设置页面

1. 点击顶部工具栏的 **"设置"** 按钮
2. 在设置页面中找到 **"提示词优化"** 标签

### 2. 配置上下文参数

#### 方式 A：使用预设模板（推荐）

1. 在 **"快速预设"** 区域，点击以下按钮之一：
   - **精简模式** - 适合简单任务
   - **平衡模式** - 适合一般任务
   - **详细模式** - 适合复杂任务

2. 系统会自动应用该预设的所有参数

#### 方式 B：手动调整参数

1. 使用滑块调整各项参数：
   - 拖动滑块改变数值
   - 实时显示当前值

2. 点击右上角的 **"保存配置"** 按钮

3. 看到 "未保存" 标签消失后，配置已生效

### 3. 重置为默认值

如果想恢复默认设置，点击 **"重置"** 按钮。

## 💡 配置建议

### 根据任务类型选择

| 任务类型 | 推荐消息数 | 推荐长度 | 说明 |
|---------|----------|---------|------|
| 简单问答 | 5-10 条 | 500-1000 字符 | 减少 token，节省成本 |
| 代码重构 | 10-20 条 | 1000-2000 字符 | 平衡质量与成本 |
| 复杂调试 | 20-50 条 | 2000-5000 字符 | 完整上下文，提高准确性 |
| Bug 修复 | 15-25 条 | 1500-3000 字符 | 包含足够的错误信息 |

### 根据 API 定价选择

- **低成本 API**（如 Deepseek）：可以使用详细模式
- **高成本 API**（如 GPT-4）：建议使用精简或平衡模式
- **免费额度有限**：使用精简模式

### 优化技巧

1. **对话开始时**：使用精简模式（5-10 条）
   - 上下文少，优化速度快

2. **对话进行中**：使用平衡模式（10-20 条）
   - 有一定上下文，优化质量好

3. **复杂问题**：使用详细模式（20-50 条）
   - 完整上下文，理解更准确

4. **调试场景**：启用"包含执行结果"
   - 让 AI 看到错误信息，优化更精准

## 🔧 技术细节

### 上下文提取逻辑

```
1. 过滤系统初始化消息
2. 过滤空消息
3. 提取最近 N 条有效消息
4. 按配置截断过长的消息
5. 格式化为文本传递给 API
```

### 上下文格式示例

```
用户: 我想实现一个用户登录功能
助手: 好的，我可以帮你实现。你想用什么技术栈？
用户: React + TypeScript + Node.js
助手: 我会为你创建前后端的登录功能...[截断]
执行结果: Created file auth.ts...[截断]
```

### 存储位置

配置保存在浏览器的 `localStorage` 中：
- Key: `prompt_context_config`
- 格式: JSON

## ❓ 常见问题

### Q1: 配置对哪些优化方式有效？

**A:** 配置对所有三种提示词优化方式都有效：
- ✅ 本地 Claude Code CLI
- ✅ Gemini CLI
- ✅ 第三方 API（OpenAI、Deepseek 等）

### Q2: 更大的上下文会消耗更多 token 吗？

**A:** 是的。更多消息和更长字符限制会增加传递给 API 的数据量，从而：
- 增加 input tokens
- 增加 API 调用成本
- 增加响应时间

但通常带来更好的优化质量。

### Q3: 如何知道当前使用了多少上下文？

**A:** 在使用优化功能时，浏览器控制台会输出：
```
[handleEnhancePrompt] Got context with 15 messages
```

### Q4: 配置会影响普通对话吗？

**A:** **不会**。这个配置只影响提示词优化功能，不影响：
- 正常的 Claude 对话
- 会话历史记录
- 其他功能

### Q5: 为什么有时优化效果不好？

可能的原因：
1. **上下文太少** - 增加消息数量
2. **消息被截断** - 增加字符限制
3. **缺少执行结果** - 启用"包含执行结果"
4. **提示词本身不清晰** - 先改进原始提示词

## 🎯 最佳实践

### ✅ 推荐做法

1. **从平衡模式开始**，根据需要调整
2. **调试场景启用执行结果**，让 AI 看到错误
3. **定期检查 API 使用量**，避免超额
4. **复杂项目使用详细模式**，简单项目用精简模式

### ❌ 避免的做法

1. ❌ 所有场景都用最大值（浪费 token）
2. ❌ 从不保存配置更改
3. ❌ 忽略"未保存"提示
4. ❌ 设置过小的值导致上下文不足

## 📊 性能影响

| 模式 | 平均 Token 消耗 | 响应时间 | 优化质量 |
|-----|---------------|---------|---------|
| 精简 | ~500 tokens | 快 | 中 |
| 平衡 | ~1500 tokens | 中 | 高 |
| 详细 | ~3000 tokens | 慢 | 很高 |

*数据基于典型编程对话场景*

## 🔄 更新日志

### v1.0.0 (当前版本)
- ✨ 初始发布
- ✅ 可配置的上下文参数
- ✅ 三种预设模板
- ✅ 实时保存和加载
- ✅ 完整的类型安全

---

**需要帮助？** 查看 [项目文档](../README.md) 或提交 [Issue](https://github.com/anyme123/claude-workbench/issues)

