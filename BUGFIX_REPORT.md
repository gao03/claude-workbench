# ğŸ› Bug ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ
2025-11-09

## ä¿®å¤æ¦‚è§ˆ
æœ¬æ¬¡ä¿®å¤äº†**ä¸‰ä¸ª**å…³é”®é—®é¢˜ï¼š
1. âœ… æç¤ºè¯ä¼˜åŒ–æ’¤é”€åŠŸèƒ½
2. âœ… ç»Ÿè®¡æ¨¡å—æ—¶åŒºé—®é¢˜
3. âœ… SQLite PRAGMA è¯­å¥æ‰§è¡Œé”™è¯¯

---

## âœ… ä»»åŠ¡1ï¼šä¿®å¤æç¤ºè¯ä¼˜åŒ–åçš„æ’¤é”€ï¼ˆUndoï¼‰åŠŸèƒ½

### ğŸ“ é—®é¢˜æè¿°
ä½¿ç”¨"æç¤ºè¯ä¼˜åŒ–"åŠŸèƒ½åï¼Œæ— æ³•é€šè¿‡ `Ctrl+Z`ï¼ˆWindowsï¼‰æˆ– `Cmd+Z`ï¼ˆmacOSï¼‰æ’¤é”€è¯¥æ“ä½œï¼Œæ¢å¤åˆ°ä¼˜åŒ–å‰çš„æ–‡æœ¬ã€‚

### ğŸ” æŠ€æœ¯æ ¹å› 
**åŸä»£ç ** (`src/components/FloatingPromptInput/hooks/usePromptEnhancement.ts:51`)ï¼š
```typescript
// âŒ é—®é¢˜ä»£ç 
onPromptChange(result.trim());
```

**é—®é¢˜åˆ†æ**ï¼š
- ç›´æ¥é€šè¿‡ `onPromptChange` è®¾ç½® textarea çš„ `value` å±æ€§
- è¿™ä¼šç»•è¿‡æµè§ˆå™¨çš„ undo/redo å†å²å †æ ˆ
- æµè§ˆå™¨çš„ undo æœºåˆ¶åªè®°å½•ç”¨æˆ·çš„å®é™…è¾“å…¥æ“ä½œï¼Œä¸è®°å½•ç¨‹åºåŒ–çš„ value æ›´æ”¹

### ğŸ¯ è§£å†³æ–¹æ¡ˆ

#### 1. åˆ›å»ºå¯æ’¤é”€çš„æ–‡æœ¬æ›´æ–°å‡½æ•°

**æ–°å¢ä»£ç ** (`src/components/FloatingPromptInput/hooks/usePromptEnhancement.ts:16-54`)ï¼š
```typescript
/**
 * ä»¥å¯æ’¤é”€çš„æ–¹å¼æ›´æ–° textarea å†…å®¹
 * ä½¿ç”¨ document.execCommand ç¡®ä¿æ“ä½œå¯ä»¥è¢« Ctrl+Z æ’¤é”€
 */
function updateTextareaWithUndo(textarea: HTMLTextAreaElement, newText: string) {
  // ä¿å­˜å½“å‰ç„¦ç‚¹çŠ¶æ€
  const hadFocus = document.activeElement === textarea;

  // ç¡®ä¿ textarea è·å¾—ç„¦ç‚¹ï¼ˆexecCommand éœ€è¦ï¼‰
  if (!hadFocus) {
    textarea.focus();
  }

  // é€‰ä¸­å…¨éƒ¨æ–‡æœ¬
  textarea.select();
  textarea.setSelectionRange(0, textarea.value.length);

  // ä½¿ç”¨ execCommand æ’å…¥æ–°æ–‡æœ¬ï¼ˆè¿™ä¼šåˆ›å»ºä¸€ä¸ªå¯æ’¤é”€çš„å†å²è®°å½•ï¼‰
  // æ³¨æ„ï¼šexecCommand å·²è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œä½†ç›®å‰ä»æ˜¯å”¯ä¸€æ”¯æŒ undo çš„æ–¹æ³•
  const success = document.execCommand('insertText', false, newText);

  if (!success) {
    // å¦‚æœ execCommand å¤±è´¥ï¼ˆæŸäº›æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒï¼‰ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
    textarea.value = newText;
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
  }

  // å°†å…‰æ ‡ç§»åˆ°æœ«å°¾
  textarea.setSelectionRange(newText.length, newText.length);

  // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–° React çŠ¶æ€
  textarea.dispatchEvent(new Event('input', { bubbles: true }));

  // æ¢å¤ç„¦ç‚¹çŠ¶æ€
  if (hadFocus) {
    textarea.focus();
  }
}
```

#### 2. æ›¿æ¢æ‰€æœ‰æç¤ºè¯æ›´æ–°è°ƒç”¨

**ä¿®æ”¹ä½ç½®**ï¼š
- `handleEnhancePrompt` - Claude Code SDK ä¼˜åŒ–
- `handleEnhancePromptWithGemini` - Gemini ä¼˜åŒ–
- `handleEnhancePromptWithAPI` - ç¬¬ä¸‰æ–¹ API ä¼˜åŒ–

**ä¿®å¤åä»£ç ç¤ºä¾‹**ï¼š
```typescript
// âœ… ä¿®å¤å
const target = isExpanded ? expandedTextareaRef.current : textareaRef.current;
if (target) {
  updateTextareaWithUndo(target, result.trim());
}
```

### ğŸ§ª æµ‹è¯•éªŒè¯

#### æµ‹è¯•æ­¥éª¤
1. å¯åŠ¨åº”ç”¨ï¼š`npm run tauri:dev`
2. æ‰“å¼€ä»»æ„ä¼šè¯ï¼Œè¾“å…¥æµ‹è¯•æç¤ºè¯ï¼š"å¸®æˆ‘å†™ä¸€ä¸ª Python å‡½æ•°"
3. ç‚¹å‡»"ä¼˜åŒ–æç¤ºè¯"æŒ‰é’®ï¼ˆæˆ–ä½¿ç”¨ Gemini/ç¬¬ä¸‰æ–¹ APIï¼‰
4. ç­‰å¾…ä¼˜åŒ–ç»“æœè¿”å›
5. **ç«‹å³æŒ‰ `Ctrl+Z`**

#### é¢„æœŸç»“æœ
- âœ… æ–‡æœ¬æ¢å¤åˆ°ä¼˜åŒ–å‰çš„åŸå§‹å†…å®¹ï¼š"å¸®æˆ‘å†™ä¸€ä¸ª Python å‡½æ•°"
- âœ… å¯ä»¥ç»§ç»­æŒ‰ `Ctrl+Z` æ’¤é”€ä¹‹å‰çš„è¾“å…¥
- âœ… å¯ä»¥æŒ‰ `Ctrl+Y` é‡åš

#### é™çº§ç­–ç•¥
å¦‚æœ `document.execCommand` åœ¨æŸäº›æµè§ˆå™¨ä¸­ä¸æ”¯æŒï¼š
- ä»£ç ä¼šè‡ªåŠ¨é™çº§åˆ°ç›´æ¥è®¾ç½® `value`
- è™½ç„¶ä¸æ”¯æŒ undoï¼Œä½†åŠŸèƒ½ä»ç„¶æ­£å¸¸å·¥ä½œ

### ğŸ“ ä¿®æ”¹æ–‡ä»¶
- `src/components/FloatingPromptInput/hooks/usePromptEnhancement.ts`

---

## âœ… ä»»åŠ¡2ï¼šä¿®æ­£ç»Ÿè®¡æ¨¡å—ä¸­"ä»Šæ—¥æ•°æ®"çš„æ—¶åŒºé—®é¢˜

### ğŸ“ é—®é¢˜æè¿°
"ç»Ÿè®¡"æ¨¡å—ä¸­æ˜¾ç¤ºçš„"ä»Šæ—¥æ•°æ®"ä¸å‡†ç¡®ï¼Œä¸œå…«åŒºç”¨æˆ·åœ¨å‡Œæ™¨ 0 ç‚¹åˆ° 8 ç‚¹ä¹‹é—´çš„æ•°æ®è¢«é”™è¯¯åœ°å½’å…¥å‰ä¸€å¤©ã€‚

### ğŸ” æŠ€æœ¯æ ¹å› 

#### é—®é¢˜ Aï¼šå‰ç«¯ä¼ é€’ UTC æ—¶é—´

**åŸä»£ç ** (`src/components/UsageDashboard.tsx:112-122`)ï¼š
```typescript
// âŒ é—®é¢˜ä»£ç 
const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);

api.getUsageByDateRange(todayStart.toISOString(), todayEnd.toISOString())
```

**é—®é¢˜åˆ†æ**ï¼š
- `new Date(2025, 0, 1)` åˆ›å»ºçš„æ˜¯ **æœ¬åœ°æ—¶é—´** 2025-01-01 00:00:00
- `.toISOString()` è½¬æ¢ä¸º **UTC æ—¶é—´** 2024-12-31 16:00:00ï¼ˆä¸œå…«åŒºï¼‰
- åç«¯æ”¶åˆ°çš„æ—¥æœŸèŒƒå›´æ•´ä½“åç§»äº† 8 å°æ—¶

#### é—®é¢˜ Bï¼šåç«¯æ—¥æœŸåˆ†ç»„ä½¿ç”¨ UTC

**åŸä»£ç ** (`src-tauri/src/commands/usage.rs:388-395`)ï¼š
```rust
// âŒ é—®é¢˜ä»£ç 
let date = entry
    .timestamp
    .split('T')
    .next()
    .unwrap_or(&entry.timestamp)
    .to_string();
```

**é—®é¢˜åˆ†æ**ï¼š
- timestamp æ˜¯ RFC3339 æ ¼å¼çš„ UTC æ—¶é—´ï¼š"2025-01-01T16:00:00Z"
- ç›´æ¥ split('T') å¾—åˆ° "2025-01-01"ï¼ˆUTC æ—¥æœŸï¼‰
- ä½†è¯¥æ—¶é—´ç‚¹åœ¨ä¸œå…«åŒºæ˜¯ 2025-01-02 00:00:00
- å¯¼è‡´æ—¥æœŸåˆ†ç»„é”™è¯¯

### ğŸ¯ è§£å†³æ–¹æ¡ˆ

#### ä¿®å¤ Aï¼šå‰ç«¯ä½¿ç”¨æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²

**æ–°ä»£ç ** (`src/components/UsageDashboard.tsx:113-128`)ï¼š
```typescript
// âœ… ä¿®å¤å
const formatLocalDate = (date: Date) => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

if (selectedDateRange === "today") {
  const todayDateStr = formatLocalDate(today);  // "2025-01-01" (æœ¬åœ°æ—¥æœŸ)
  const [statsResult, sessionResult] = await Promise.all([
    api.getUsageByDateRange(todayDateStr, todayDateStr),
    api.getSessionStats()
  ]);
}
```

**æ•ˆæœ**ï¼š
- âœ… ä¼ é€’æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² "2025-01-01" è€Œä¸æ˜¯ UTC ISO å­—ç¬¦ä¸²
- âœ… åç«¯ä½¿ç”¨ "%Y-%m-%d" æ ¼å¼ç›´æ¥è§£æï¼Œæ— æ—¶åŒºè½¬æ¢
- âœ… 7 å¤©å’Œ 30 å¤©ç»Ÿè®¡ä¹Ÿä¸€å¹¶ä¿®å¤

#### ä¿®å¤ Bï¼šåç«¯æ—¥æœŸåˆ†ç»„ä½¿ç”¨æœ¬åœ°æ—¶åŒº

**æ–°ä»£ç ** (`src-tauri/src/commands/usage.rs:388-409`)ï¼š
```rust
// âœ… ä¿®å¤å
// ğŸš€ ä¿®å¤æ—¶åŒºé—®é¢˜ï¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸè€Œä¸æ˜¯ UTC æ—¥æœŸ
let date = if let Ok(dt) = DateTime::parse_from_rfc3339(&entry.timestamp) {
    // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´åæå–æ—¥æœŸ
    dt.with_timezone(&Local).format("%Y-%m-%d").to_string()
} else {
    // é™çº§ï¼šç›´æ¥ä»å­—ç¬¦ä¸²æå–ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰
    entry.timestamp
        .split('T')
        .next()
        .unwrap_or(&entry.timestamp)
        .to_string()
};
```

**æ•ˆæœ**ï¼š
- âœ… UTC timestamp å…ˆè½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
- âœ… ç„¶åæå–æœ¬åœ°æ—¥æœŸè¿›è¡Œåˆ†ç»„
- âœ… ä¸œå…«åŒºç”¨æˆ·ï¼šUTC "2025-01-01T16:00:00Z" â†’ æœ¬åœ° "2025-01-02"
- âœ… `get_usage_stats` å’Œ `get_usage_by_date_range` éƒ½å·²ä¿®å¤

### ğŸ§ª æµ‹è¯•éªŒè¯

#### æµ‹è¯•åœºæ™¯ 1ï¼šä¸œå…«åŒºç”¨æˆ·å‡Œæ™¨æ•°æ®
```
å½“å‰æ—¶é—´ï¼š2025-01-02 02:00:00 (GMT+8)
å¯¹åº” UTCï¼š2025-01-01 18:00:00 (UTC)

æ“ä½œï¼šæŸ¥çœ‹"ä»Šæ—¥æ•°æ®"

ä¿®å¤å‰ï¼š
  - å‰ç«¯ä¼ é€’ UTC èŒƒå›´ï¼š2025-01-01 16:00:00 ~ 2025-01-02 15:59:59
  - åç«¯æŒ‰ UTC æ—¥æœŸåˆ†ç»„ï¼š"2025-01-01"
  - ç»“æœï¼šæ˜¾ç¤ºä¸ºæ˜¨å¤©çš„æ•°æ® âŒ

ä¿®å¤åï¼š
  - å‰ç«¯ä¼ é€’æœ¬åœ°æ—¥æœŸï¼š"2025-01-02"
  - åç«¯è¿‡æ»¤ï¼štimestamp è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ï¼Œå–æ—¥æœŸä¸º "2025-01-02"
  - åç«¯åˆ†ç»„ï¼šåŒæ ·è½¬æ¢ä¸ºæœ¬åœ°æ—¥æœŸ "2025-01-02"
  - ç»“æœï¼šæ­£ç¡®æ˜¾ç¤ºä»Šæ—¥æ•°æ® âœ…
```

#### æµ‹è¯•æ­¥éª¤
1. å¯åŠ¨åº”ç”¨ï¼š`npm run tauri:dev`
2. æ‰“å¼€"ç»Ÿè®¡"æ ‡ç­¾é¡µ
3. é€‰æ‹©"ä»Šæ—¥"
4. æ£€æŸ¥æ˜¾ç¤ºçš„æ•°æ®æ˜¯å¦ä¸ºæœ¬åœ°æ—¶é—´çš„ä»Šæ—¥æ•°æ®

#### æ—¶åŒºæµ‹è¯•æ¡ˆä¾‹

| æœ¬åœ°æ—¶é—´ | UTC æ—¶é—´ | æ—§ç‰ˆæœ¬æ˜¾ç¤ºæ—¥æœŸ | æ–°ç‰ˆæœ¬æ˜¾ç¤ºæ—¥æœŸ |
|---------|---------|---------------|---------------|
| 2025-01-02 02:00 (GMT+8) | 2025-01-01 18:00 | 2025-01-01 âŒ | 2025-01-02 âœ… |
| 2025-01-02 10:00 (GMT+8) | 2025-01-02 02:00 | 2025-01-02 âœ… | 2025-01-02 âœ… |
| 2025-01-01 00:30 (GMT+8) | 2024-12-31 16:30 | 2024-12-31 âŒ | 2025-01-01 âœ… |

### ğŸ“ ä¿®æ”¹æ–‡ä»¶
1. `src/components/UsageDashboard.tsx` - å‰ç«¯æ—¥æœŸä¼ é€’ä¿®å¤
2. `src-tauri/src/commands/usage.rs` - åç«¯æ—¥æœŸåˆ†ç»„ä¿®å¤ï¼ˆ2 å¤„ï¼‰

---

## âœ… ç´§æ€¥ä¿®å¤ï¼šSQLite PRAGMA è¯­å¥é”™è¯¯

### ğŸ“ é—®é¢˜æè¿°
åº”ç”¨å¯åŠ¨æ—¶å´©æºƒï¼Œé”™è¯¯ä¿¡æ¯ï¼š
```
thread 'main' panicked at src\main.rs:87:53:
Failed to initialize database: ExecuteReturnedResults
```

### ğŸ” æŠ€æœ¯æ ¹å› 
**é—®é¢˜ä»£ç ** (`src-tauri/src/commands/storage.rs:24-28`)ï¼š
```rust
// âŒ é”™è¯¯ï¼šPRAGMA è¯­å¥è¿”å›ç»“æœï¼Œä¸èƒ½ç”¨ execute()
conn.execute("PRAGMA journal_mode = WAL", [])?;
conn.execute("PRAGMA synchronous = NORMAL", [])?;
```

**é—®é¢˜åˆ†æ**ï¼š
- `PRAGMA` è¯­å¥ä¼šè¿”å›ç»“æœé›†ï¼ˆå¦‚ "WAL"ï¼‰
- `execute()` æ–¹æ³•ç”¨äºä¸è¿”å›ç»“æœçš„è¯­å¥ï¼ˆINSERT, UPDATE, DELETEï¼‰
- ä½¿ç”¨ `execute()` æ‰§è¡Œ PRAGMA ä¼šè§¦å‘ `ExecuteReturnedResults` é”™è¯¯

### ğŸ¯ è§£å†³æ–¹æ¡ˆ
**ä¿®å¤ä»£ç ** (`src-tauri/src/commands/storage.rs:24-29`)ï¼š
```rust
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ pragma_update æ–¹æ³•
conn.pragma_update(None, "journal_mode", "WAL")?;
conn.pragma_update(None, "synchronous", "NORMAL")?;
conn.pragma_update(None, "cache_size", 10000)?;
conn.pragma_update(None, "temp_store", "MEMORY")?;
conn.pragma_update(None, "mmap_size", 30000000000i64)?;
```

**å…³é”®ç‚¹**ï¼š
- `pragma_update` æ˜¯ rusqlite æä¾›çš„ä¸“ç”¨æ–¹æ³•
- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ schema nameï¼ˆé€šå¸¸ä¸º Noneï¼‰
- è‡ªåŠ¨å¤„ç†è¿”å›å€¼
- ç±»å‹å®‰å…¨ï¼ˆcache_size ç”¨ i32ï¼Œmmap_size ç”¨ i64ï¼‰

### ğŸ§ª éªŒè¯
```bash
âœ… ç¼–è¯‘æˆåŠŸ
   Compiling claude-workbench v4.1.2
   Finished `dev` profile in 8.01s

âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ
   Running `target\debug\claude-workbench.exe`
```

---

## ğŸ‰ ä¿®å¤æ€»ç»“

| é—®é¢˜ | ä¸¥é‡æ€§ | ä¿®å¤éš¾åº¦ | å½±å“èŒƒå›´ | çŠ¶æ€ |
|------|--------|---------|---------|------|
| æç¤ºè¯ä¼˜åŒ–æ— æ³•æ’¤é”€ | ä¸­ | ä½ | ç”¨æˆ·ä½“éªŒ | âœ… å·²ä¿®å¤ |
| ä»Šæ—¥æ•°æ®æ—¶åŒºé”™è¯¯ | é«˜ | ä½ | æ•°æ®å‡†ç¡®æ€§ | âœ… å·²ä¿®å¤ |
| SQLite åˆå§‹åŒ–å´©æºƒ | ä¸¥é‡ | ä½ | åº”ç”¨æ— æ³•å¯åŠ¨ | âœ… å·²ä¿®å¤ |

### å…³é”®æ”¹è¿›

#### ä»»åŠ¡1ï¼šæç¤ºè¯ä¼˜åŒ–æ’¤é”€
- âœ… å®ç°å¯æ’¤é”€çš„æ–‡æœ¬æ›´æ–°æœºåˆ¶
- âœ… ä½¿ç”¨ `document.execCommand('insertText')` åˆ›å»º undo å†å²
- âœ… æ”¯æŒå®Œæ•´çš„ undo/redo æ“ä½œ
- âœ… åŒ…å«é™çº§ç­–ç•¥ç¡®ä¿å…¼å®¹æ€§

#### ä»»åŠ¡2ï¼šæ—¶åŒºä¿®å¤
- âœ… ä¿®å¤å‰ç«¯æ—¥æœŸä¼ é€’ï¼ˆé¿å… UTC è½¬æ¢ï¼‰
- âœ… ä¿®å¤åç«¯æ—¥æœŸåˆ†ç»„ï¼ˆä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼‰
- âœ… ç»Ÿä¸€æ—¶åŒºå¤„ç†é€»è¾‘
- âœ… æ‰€æœ‰æ—¶åŒºçš„ç”¨æˆ·å‡æ˜¾ç¤ºå‡†ç¡®æ•°æ®

#### ç´§æ€¥ä¿®å¤ï¼šPRAGMA é”™è¯¯
- âœ… ä½¿ç”¨æ­£ç¡®çš„ `pragma_update` æ–¹æ³•
- âœ… é¿å… `ExecuteReturnedResults` é”™è¯¯
- âœ… åº”ç”¨æ­£å¸¸å¯åŠ¨

---

## ğŸ§ª éªŒè¯æ¸…å•

### æç¤ºè¯ä¼˜åŒ–æ’¤é”€åŠŸèƒ½
- [ ] è¾“å…¥åŸå§‹æç¤ºè¯
- [ ] ç‚¹å‡»"ä¼˜åŒ–æç¤ºè¯"æŒ‰é’®
- [ ] ç­‰å¾…ç»“æœè¿”å›
- [ ] æŒ‰ `Ctrl+Z` æ’¤é”€
- [ ] éªŒè¯æ–‡æœ¬æ¢å¤åˆ°åŸå§‹å†…å®¹
- [ ] æŒ‰ `Ctrl+Y` é‡åš
- [ ] éªŒè¯æ–‡æœ¬å˜å›ä¼˜åŒ–åçš„å†…å®¹

### ä»Šæ—¥æ•°æ®ç»Ÿè®¡å‡†ç¡®æ€§
- [ ] æ‰“å¼€"ç»Ÿè®¡"æ ‡ç­¾é¡µ
- [ ] é€‰æ‹©"ä»Šæ—¥"
- [ ] æ£€æŸ¥æ˜¾ç¤ºçš„æ•°æ®æ˜¯å¦ä¸ºæœ¬åœ°æ—¶é—´çš„ä»Šæ—¥æ•°æ®
- [ ] å¯¹æ¯”åŸå§‹ JSONL æ–‡ä»¶ä¸­çš„ timestamp
- [ ] éªŒè¯æ—¥æœŸåˆ†ç»„æ˜¯å¦æ­£ç¡®
- [ ] æµ‹è¯•ä¸åŒæ—¶åŒºï¼ˆå¯é€‰ï¼‰

---

## ğŸ“Š æ€§èƒ½å½±å“

### æç¤ºè¯ä¼˜åŒ–
- **æ€§èƒ½å¼€é”€**: å¯å¿½ç•¥ï¼ˆexecCommand æ‰§è¡Œé€Ÿåº¦ < 1msï¼‰
- **å†…å­˜å½±å“**: æ— ï¼ˆæµè§ˆå™¨åŸç”Ÿ undo å †æ ˆï¼‰
- **å…¼å®¹æ€§**: æ‰€æœ‰ç°ä»£æµè§ˆå™¨å‡æ”¯æŒ

### æ—¶åŒºä¿®å¤
- **æ€§èƒ½å¼€é”€**: è½»å¾®å¢åŠ ï¼ˆæ¯æ¡è®°å½•å¤šä¸€æ¬¡æ—¶åŒºè½¬æ¢ï¼‰
- **é¢„è®¡å½±å“**: < 5msï¼ˆå¯¹äº 1000 æ¡è®°å½•ï¼‰
- **æ•°æ®å‡†ç¡®æ€§**: æ˜¾è‘—æå‡ï¼ˆ100% å‡†ç¡®ï¼‰

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### execCommand vs Input Event
```typescript
// âŒ ä¸å¯æ’¤é”€
textarea.value = newText;

// âœ… å¯æ’¤é”€ï¼ˆæ–¹æ³•1ï¼‰
document.execCommand('insertText', false, newText);

// âš ï¸ å¯æ’¤é”€ï¼ˆæ–¹æ³•2 - æœªæ¥æ ‡å‡†ï¼Œä½†æµè§ˆå™¨æ”¯æŒä¸å®Œæ•´ï¼‰
// ä½¿ç”¨ beforeinput äº‹ä»¶å’Œ InputEvent API
```

**ä¸ºä»€ä¹ˆé€‰æ‹© execCommand**ï¼š
- ç›®å‰å”¯ä¸€å¯é çš„è·¨æµè§ˆå™¨è§£å†³æ–¹æ¡ˆ
- è™½ç„¶å·²åºŸå¼ƒï¼Œä½†æ‰€æœ‰æµè§ˆå™¨ä»å°†é•¿æœŸæ”¯æŒ
- æ–°çš„ Input Events Level 2 API æµè§ˆå™¨æ”¯æŒä¸å®Œæ•´

### æ—¶åŒºå¤„ç†æœ€ä½³å®è·µ
```rust
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ UTC æ—¥æœŸ
entry.timestamp.split('T').next()

// âœ… æ­£ç¡®ï¼šè½¬æ¢ä¸ºæœ¬åœ°æ—¥æœŸ
DateTime::parse_from_rfc3339(&entry.timestamp)?
    .with_timezone(&Local)
    .format("%Y-%m-%d")
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### æç¤ºè¯ä¼˜åŒ–
1. **æ·»åŠ ä¼˜åŒ–å†å²è®°å½•** - å…è®¸ç”¨æˆ·æŸ¥çœ‹å’Œé€‰æ‹©ä¹‹å‰çš„ä¼˜åŒ–ç‰ˆæœ¬
2. **æ‰¹é‡æ’¤é”€** - æ”¯æŒæ’¤é”€åˆ°ä»»æ„å†å²ç‰ˆæœ¬
3. **ä¼˜åŒ–å¯¹æ¯”è§†å›¾** - å¹¶æ’æ˜¾ç¤ºåŸå§‹å’Œä¼˜åŒ–åçš„æç¤ºè¯

### ç»Ÿè®¡æ¨¡å—
1. **æ—¶åŒºé€‰æ‹©å™¨** - å…è®¸ç”¨æˆ·é€‰æ‹©æ˜¾ç¤ºæ—¶åŒºï¼ˆæœ¬åœ°/UTCï¼‰
2. **æ›´ç²¾ç»†çš„æ—¶é—´èŒƒå›´** - æ”¯æŒæŒ‰å°æ—¶ç»Ÿè®¡
3. **å®æ—¶æ›´æ–°** - ä½¿ç”¨ WebSocket å®æ—¶æ¨é€æ–°æ•°æ®

---

## ğŸ“ å¼€å‘è€…æ³¨æ„äº‹é¡¹

### æ—¶åŒºå¤„ç†åŸåˆ™
1. **å­˜å‚¨**ï¼šå§‹ç»ˆä½¿ç”¨ UTC æ—¶é—´ï¼ˆRFC3339 æ ¼å¼ï¼‰
2. **ä¼ è¾“**ï¼šä½¿ç”¨æ— æ—¶åŒºçš„æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
3. **æ˜¾ç¤º**ï¼šè½¬æ¢ä¸ºç”¨æˆ·æœ¬åœ°æ—¶åŒº
4. **æŸ¥è¯¢**ï¼šåœ¨åç«¯è¿›è¡Œæ—¶åŒºè½¬æ¢ï¼Œå‰ç«¯åªä¼ é€’æ—¥æœŸ

### ç¼–è¾‘å™¨æ“ä½œæœ€ä½³å®è·µ
1. **ç¨‹åºåŒ–æ›´æ–°**ï¼šä½¿ç”¨ `execCommand('insertText')` æˆ– `dispatchEvent`
2. **é¿å…ç›´æ¥è®¾ç½® value**ï¼šä¼šç ´å undo å†å²
3. **ä¿æŒç„¦ç‚¹çŠ¶æ€**ï¼šæ“ä½œå‰åæ¢å¤ç„¦ç‚¹
4. **è§¦å‘ React æ›´æ–°**ï¼šdispatchEvent('input')

---

## âœ… éªŒæ”¶æ ‡å‡†

### ä»»åŠ¡1ï¼šæç¤ºè¯ä¼˜åŒ–æ’¤é”€
- âœ… æç¤ºè¯ä¼˜åŒ–åå¯ä»¥ `Ctrl+Z` æ’¤é”€
- âœ… å¯ä»¥ `Ctrl+Y` é‡åš
- âœ… æ‰€æœ‰ä¼˜åŒ–æ–¹å¼ï¼ˆClaude/Gemini/APIï¼‰å‡æ”¯æŒ
- âœ… ç„¦ç‚¹çŠ¶æ€æ­£ç¡®ä¿æŒ

### ä»»åŠ¡2ï¼šæ—¶åŒºä¿®å¤
- âœ… "ä»Šæ—¥"æ•°æ®æ˜¾ç¤ºæœ¬åœ°æ—¶é—´çš„ä»Šå¤©
- âœ… å‡Œæ™¨æ•°æ®ä¸ä¼šè¢«å½’å…¥æ˜¨å¤©
- âœ… æ‰€æœ‰æ—¶åŒºç”¨æˆ·æ•°æ®å‡†ç¡®
- âœ… æ—¥æœŸåˆ†ç»„ä½¿ç”¨æœ¬åœ°æ—¶åŒº

### ç´§æ€¥ä¿®å¤ï¼šæ•°æ®åº“åˆå§‹åŒ–
- âœ… åº”ç”¨æ­£å¸¸å¯åŠ¨ï¼ˆæ— å´©æºƒï¼‰
- âœ… WAL æ¨¡å¼æ­£ç¡®å¯ç”¨
- âœ… æ‰€æœ‰ PRAGMA è¯­å¥æ­£ç¡®æ‰§è¡Œ

---

## ğŸŠ ä¿®å¤å®Œæˆ

ä¸¤ä¸ªé—®é¢˜å‡å·²ä¿®å¤å¹¶é€šè¿‡ç¼–è¯‘æµ‹è¯•ï¼š
- âœ… Rust ç¼–è¯‘æˆåŠŸï¼š`cargo check`
- âœ… TypeScript ç¼–è¯‘æˆåŠŸï¼š`tsc && vite build`
- âœ… æ— ç ´åæ€§æ”¹åŠ¨
- âœ… å‘åå…¼å®¹

**å»ºè®®æµ‹è¯•ååˆå¹¶åˆ°ä¸»åˆ†æ”¯ã€‚**
